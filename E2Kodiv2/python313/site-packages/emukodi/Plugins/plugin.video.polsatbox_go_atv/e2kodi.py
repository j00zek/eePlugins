#contains own functions to minimize modifications of the oryginal script
import e2kodi__init__ # aby zainicjowac sciezki i nie musiec zmieniac czegos w kodzie

import os, sys
from urllib.parse import parse_qsl

from xbmcE2 import *

import xbmc
import xbmcaddon
import xbmcgui
import xbmcplugin
import xbmcvfs

params = dict(parse_qsl(sys.argv[2][1:]))

mode = params.get('mode', None)

if __name__ == '__main__':
    if len(params) <1:
        print('brak parametrów uruchomieniowych :(')
    elif not mode is None:
        if mode=='listE2B':
            from addon import getTVList
            
            addon = xbmcaddon.Addon(id='plugin.video.polsatbox_go_atv')
            data_dir = addon.getSetting('path_m3u')
            
            xbmcgui.Dialog().notification('PolsatBoxGO 4K', 'Generuję listę E2B.', xbmcgui.NOTIFICATION_INFO)
            chans=getTVList()
            if chans:
                dataE2 = '' #j00zek for E2 bouquets
                for c in chans['result']['results']:
                    chName=c['title']
                    mediaid=c['id']
                    cpid=str(c['cpid'])
                    #img=getImage(c['thumbnails'])
                    #data += '#EXTINF:0 tvg-id="%s" tvg-logo="%s" group-title="PolsatBox Go" ,%s\nplugin://plugin.video.polsatbox_go_atv?mode=playTV&mediaid=%s&cpid=%s&type=tv\n' %(chName,img,chName,mediaid,cpid)
                    dataE2 += 'plugin.video.polsatbox_go_atv/addon.py?mode=playTV&mediaid=%s&cpid=%s&type=tv:%s\n' % (mediaid, cpid, chName) #j00zek for E2 bouquets

                f = xbmcvfs.File(os.path.join(data_dir, 'iptv.e2b'), 'w') #j00zek for E2 bouquets
                f.write(dataE2)
                f.close()
                xbmcgui.Dialog().notification('PolsatBoxGO 4K', 'Wygenerowano listę E2B', xbmcgui.NOTIFICATION_INFO)
